# Docker Compose for Supervisor Agent System
#
# Quick Start:
#   1. Copy .env.example to .env and fill in your API keys
#   2. Run: docker-compose up --build
#   3. Open: http://localhost:8000 (backend) or http://localhost:3000 (frontend)
#
# Note: PostgreSQL and Redis are OPTIONAL - the system works without them.

services:
  # Backend API with Supervisor Agent System
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    image: supervisor-backend:latest
    container_name: supervisor-backend
    environment:
      # Environment
      ENVIRONMENT: development

      # API
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_RELOAD: "true"
      CORS_ORIGINS: http://localhost:3000,http://localhost:8000,http://127.0.0.1:8000,http://127.0.0.1:3000

      # PostgreSQL (OPTIONAL - system works without it)
      # Set these if you want session persistence
      POSTGRES_HOST: ${POSTGRES_HOST:-localhost}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-dv360agent}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

      # Redis (OPTIONAL - system works without it)
      # Set these if you want caching and rate limiting
      REDIS_HOST: ${REDIS_HOST:-localhost}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # LLM (REQUIRED - at least one must be set)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # LangSmith Tracing (OPTIONAL - for debugging)
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2:-false}
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY:-}
      LANGCHAIN_PROJECT: ${LANGCHAIN_PROJECT:-dv360-agent-system}
      LANGSMITH_ENDPOINT: ${LANGSMITH_ENDPOINT:-https://api.smith.langchain.com}

      # Snowflake (REQUIRED for data queries)
      SNOWFLAKE_ACCOUNT: ${SNOWFLAKE_ACCOUNT:-}
      SNOWFLAKE_USER: ${SNOWFLAKE_USER:-}
      SNOWFLAKE_PASSWORD: ${SNOWFLAKE_PASSWORD:-}
      SNOWFLAKE_WAREHOUSE: ${SNOWFLAKE_WAREHOUSE:-}
      SNOWFLAKE_DATABASE: ${SNOWFLAKE_DATABASE:-}
      SNOWFLAKE_SCHEMA: ${SNOWFLAKE_SCHEMA:-}
      SNOWFLAKE_ROLE: ${SNOWFLAKE_ROLE:-}
      SNOWFLAKE_PRIVATE_KEY_PATH: ${SNOWFLAKE_PRIVATE_KEY_PATH:-/app/rsa_key.p8}

      # Logging
      LOG_LEVEL: INFO

      # Telemetry
      ENABLE_PROMETHEUS: "true"
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_cache:/app/.cache
    networks:
      - supervisor-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/liveness"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend (static HTML served by nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: supervisor-frontend:latest
    container_name: supervisor-frontend
    ports:
      - "3000:80"
    networks:
      - supervisor-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # OPTIONAL: Uncomment below to run local PostgreSQL and Redis
  # ============================================================
  # postgres:
  #   image: pgvector/pgvector:pg16
  #   container_name: supervisor-postgres
  #   environment:
  #     POSTGRES_DB: dv360agent
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - supervisor-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # redis:
  #   image: redis:7-alpine
  #   container_name: supervisor-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - supervisor-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  backend_cache:
  # postgres_data:  # Uncomment if using local PostgreSQL
  # redis_data:     # Uncomment if using local Redis

networks:
  supervisor-network:
    driver: bridge
